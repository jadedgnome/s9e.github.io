<!DOCTYPE html>
<title>Content from Mastodon</title>
<style>body{margin:0}iframe{border:0;height:100vh;width:100%}</style>
<script>
((document, hash) =>
{
	// Setting this to true will allow third party toots in the form "user@host/id"
	const allowHost = true;

	const iframe = /** @type {!HTMLIFrameElement} */ (document.createElement('iframe'));
	iframe.scrolling = 'no';
	iframe.onload = () =>
	{
		pollHeight();
		setTimeout(pollHeight, 2000);
	};

	function pollHeight()
	{
		iframe.contentWindow.postMessage(
			{
				'id':   0,
				'type': 'setHeight'
			},
			'*'
		);
	}

	let height,
		host   = 'mastodon.social',
		port,
		regexp = /@([-.\w]+)/,
		m      = regexp.exec(hash);
	if (allowHost && m)
	{
		// Extract the host part of the hash
		host = m[1];
		hash = hash.replace(regexp, '');
	}
	window.onmessage = (e) =>
	{
		e.stopImmediatePropagation();
		if (e.data === 's9e:init' && !port)
		{
			port = e.ports[0];

			// Display the iframe only after the parent has given the go-ahead.
			// Visiting the page on GitHub directly will only display a blank page
			iframe.src = '//' + host + '/@' + hash.replace(/[^\w/]/g, '') + '/embed';
			document.body.appendChild(iframe);
		}
		else if (e.source === iframe.contentWindow)
		{
			height = +e.data.height;
		}

		if (height && port)
		{
			port.postMessage(height);
		}
	};
})(document, location.hash);
</script>