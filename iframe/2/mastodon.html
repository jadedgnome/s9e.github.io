<!DOCTYPE html>
<title>Content from Mastodon</title>
<style>body{margin:0}iframe{border:0;height:100vh;width:100%}</style>
<script>
((document, hash) =>
{
	// Setting this to true will allow third party toots in the form "user@host/id"
	const allowHost = true;

	const iframe = /** @type {!HTMLIFrameElement} */ (document.createElement('iframe'));
	iframe.scrolling = 'no';
	iframe.onload = () =>
	{
		delay = 0;
		schedule();
	};
	function pollHeight()
	{
		iframe.contentWindow.postMessage(
			{
				'id':   0,
				'type': 'setHeight'
			},
			'*'
		);
	}
	function schedule()
	{
		clearTimeout(timeoutId);
		timeoutId = setTimeout(pollHeight, delay);
		delay += 500;
	}

	let delay      = 500,
		height,
		host       = 'mastodon.social',
		lastHeight,
		port,
		regexp     = /@([-.\w]+)/,
		m          = regexp.exec(hash),
		timeoutId  = 0;
	if (allowHost && m)
	{
		// Extract the host part of the hash
		host = m[1];
		hash = hash.replace(regexp, '');
	}
	window.onmessage = (e) =>
	{
		e.stopImmediatePropagation();
		if (e.data === 's9e:init' && !port)
		{
			port = e.ports[0];

			// Display the iframe only after the parent has given the go-ahead.
			// Visiting the page on GitHub directly will only display a blank page
			iframe.src = '//' + host + '/@' + hash.replace(/[^\w/]/g, '') + '/embed';
			document.body.appendChild(iframe);
		}
		else if (e.source === iframe.contentWindow)
		{
			lastHeight = height;
			height     = +e.data.height;
		}

		if (height !== lastHeight)
		{
			port.postMessage(height);
		}
	};

	schedule();
})(document, location.hash);
</script>